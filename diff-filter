#!/usr/bin/env bb

(ns diff-filter
  (:require [clojure.string :as str]
            [clojure.tools.cli :as cli]
            diff))

(defn evaluate [form content]
  (eval `(let [~'content ~content]
           ~form)))

(def cli-opts
  [["-m" "--match MATCH" "Filter by regular expression"]
   ["-n" "--negate" "Negate the filter condition"
    :id :negate?]])

(let [{{:keys [negate? match]} :options [code] :arguments} (cli/parse-opts *command-line-args* cli-opts)
      code (cond
             match
             , `(re-find (re-pattern ~match) ~'content)
             code
             , (read-string code))
      process (if negate? not identity)]
  (->> (slurp *in*)
       diff/files
       (filter (fn [content]
                 (process (evaluate code content))))
       (str/join "\n")
       println))
